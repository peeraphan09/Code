<%- include('../../_header') %>

<div class="container mt-4">
  <h3>แก้ไขบิลค่าน้ำ-ค่าไฟ</h3>
  <form action="/admin/payments/edit/<%= bill.id %>" method="POST">
    <div class="mb-3">
      <label>เลือกห้อง</label>
      <select name="contract_id" id="contractSelect" class="form-control" required>
      <option value="">-- เลือกห้อง --</option>
      <% contracts.forEach(c => { %>
        <option value="<%= c.id %>" 
                data-tenant="<%= c.full_name %>" 
                data-rent="<%= c.price %>">
          ห้อง <%= c.room_number %> - <%= c.full_name %>
        </option>
      <% }) %>
    </select>
    </div>

    <div class="mb-3">
      <label>ผู้เช่า</label>
      <input type="text" id="tenantName" class="form-control" readonly>
    </div>

    <div class="mb-3">
      <label>ค่าเช่า</label>
      <input type="number" id="rentAmount" class="form-control" readonly>
    </div>

    <div class="mb-3">
      <label>เดือน</label>
      <input type="text" name="bill_month" class="form-control" value="<%= bill.bill_month %>" required>
    </div>

    <div class="mb-3">
      <label>ค่าน้ำ</label>
      <input type="number" name="water_amount" class="form-control" value="<%= bill.water_amount %>" readonly>
    </div>

    <div class="mb-3">
      <label>ค่าไฟ (หน่วยละ 7 บาท)</label>
      <input type="number" name="electricity_units" id="electricityUnits" class="form-control" value="<%= bill.electricity_units %>" min="0" required>
    </div>

    <div class="mb-3">
      <label>ค่าไฟรวม (คำนวณอัตโนมัติ)</label>
      <input type="number" id="electricityAmount" class="form-control" readonly value="<%= bill.electricity_amount %>">
    </div>

    <button type="submit" class="btn btn-primary">อัปเดต</button>
    <a href="/admin/pay" class="btn btn-secondary">ยกเลิก</a>
  </form>
</div>

<script>
  const contractSelect = document.getElementById('contractSelect');
  const tenantName = document.getElementById('tenantName');
  const rentAmount = document.getElementById('rentAmount');
  const electricityUnits = document.getElementById('electricityUnits');
  const electricityAmount = document.getElementById('electricityAmount');

  function updateTenantRent() {
    const selectedOption = contractSelect.options[contractSelect.selectedIndex];
    tenantName.value = selectedOption.dataset.tenant || '';
    rentAmount.value = selectedOption.dataset.rent || '';
  }

  function updateElectricityAmount() {
    electricityAmount.value = (electricityUnits.value * 7).toFixed(2);
  }

  contractSelect.addEventListener('change', updateTenantRent);
  electricityUnits.addEventListener('input', updateElectricityAmount);

  updateTenantRent();
  updateElectricityAmount();
</script>

<%- include('../../_footer') %>
